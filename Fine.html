<html>

<head>

    <script src="github-api/dist/GitHub.bundle.js"></script>

    <script>

        /*
        MIGRATE TO SWIFT FOR BETTER EASE OF USE
         */


        function GithubAPI() {
            let repo;
            let filesToCommit = [];
            let currentBranch = {};
            let newCommit = {};
            this.gh = new GitHub({
                username: 'mhubs',
                password: 'redsox08'
                /* also acceptable:
                   token: 'MY_OAUTH_TOKEN'
                 */
            });

            this.getRepo = function(){
                return repo;
            };

            this.setRepo = function (userName, repoName) {
                repo = this.gh.getRepo(userName, repoName);
                console.log(repo);
            };

            this.setBranch = function (branchName) {
                return repo.listBranches()
                    .then((branches) => {
                        let branchExists = branches.data
                            .find(branch => branch.name === branchName);
                        if (!branchExists) {
                            return repo.createBranch('master', branchName)
                                .then(() => {
                                    currentBranch.name = branchName;
                                });
                        } else {
                            currentBranch.name = branchName;
                        }
                    });
            };

            this.pushFiles = function (message, files) {
                return getCurrentCommitSHA()
                    .then(getCurrentTreeSHA)
                    .then(() => createFiles(files))
                    .then(createTree)
                    .then(() => createCommit(message))
                    .then(updateHead)
                    .catch((e) => {
                        console.error(e);
                    });
            };

            function getCurrentCommitSHA() {
                return repo.getRef('heads/' + currentBranch.name)
                    .then((ref) => {
                        currentBranch.commitSHA = ref.data.object.sha;
                    });
            }

            function getCurrentTreeSHA() {
                return repo.getCommit(currentBranch.commitSHA)
                    .then((commit) => {
                        currentBranch.treeSHA = commit.data.tree.sha;
                    });
            }

            function createFiles(files) {
                let promises = [];
                let length = files.length;
                for (let i = 0; i < length; i++) {
                    promises.push(createFile(files[i]));
                }
                return Promise.all(promises);
            }

            function createFile(file) {
                return repo.createBlob(file.content)
                    .then((blob) => {
                        filesToCommit.push({
                            sha: blob.data.sha,
                            path: file.path,
                            mode: '100644',
                            type: 'blob'
                        });
                    });
            }

            function createTree() {
                return repo.createTree(filesToCommit, currentBranch.treeSHA)
                    .then((tree) => {
                        newCommit.treeSHA = tree.data.sha;
                    });
            }

            function createCommit(message) {
                return repo.commit(currentBranch.commitSHA, newCommit.treeSHA, message)
                    .then((commit) => {
                        newCommit.sha = commit.data.sha;
                    });
            }

            function updateHead() {
                return repo.updateHead(
                    'heads/' + currentBranch.name,
                    newCommit.sha
                );
            }

            this.getFile = function (path) {


                return repo.getContents('master', path, 'true').then((file) => {
                    return JSON.stringify(file.data);
                }).catch((e) => {
                    return null;
                });

            }

            this.getFine = function(sha) {

                return repo._request('GET', `/repos/${repo.__fullname}/git/blobs/${sha}`);

            }

            this.removeFile = function(branch, path) {

                return repo.getSha(branch, path)
                    .then((response) => {

                    console.log(response.headers.etag);

                        const deleteCommit = {
                            message: `Delete the file at '${path}'`,
                            sha: response.headers.etag.substring(1, response.headers.etag.length - 1)
                        };

                        console.log(`/repos/${repo.__fullname}/contents/${path}`);

                        return repo._request('DELETE', `/repos/${repo.__fullname}/contents/${path}`, deleteCommit, null);
                    });

            }

            this.createBlob = function(content) {
                if (typeof content === 'object') {
                    postBody = content;
                } else {
                    postBody = repo._getContentObject(content);
                }

                console.log('sending content', postBody);
                return repo._request('POST', `/repos/${repo.__fullname}/git/blobs`, postBody, null);
            }

        }

        let api = new GithubAPI();
        api.setRepo('MHubs', 'mhubs.github.io');


    </script>


</head>

<body>
<p id="Battery">TESTING</p>
<input id="Image" type="file" onchange="sendFine()">
<video id="i"> </video>
<script>
    // NOTES:
    // USERNAME is converted to ID in app and sent.
    // PASSWORD is encrypted upon arrival and is stored as random letter/number combo


    //          AUTHENTICATION / USERS

    // ?auth=ID&password=PASSWORD -> JSON USER INFO/NULL (Authenticates user and sends info)
    // ?auth=ID&userProperty=PROPERTY&value=VALUE -> SUCCESS/FAIL (Change User Property)
    // ?auth=ID&getUserProperty=PROPERTY -> STRING User Property/NULL (Get User Property)


    //          CREATE USERS

    // ?createUser=ID&password=PASSWORD -> JSON USER INFO (Creates and authenticates user)


    //          DELETE USERS

    // ?deleteUser=ID&password=PASSWORD -> SUCCESS/FAIL (Deletes user)


    //          FINES
    // ?auth=ID&fine=ID -> BLOB Fine/null (Get Fine)
    // ?auth=ID&fineInfo=ID -> JSON Fine Info/NULL (Get Fine Info)
    // ?auth=ID&fineList=TRUE -> JSON Fine IDS (List Fines)
    // ?auth=ID&createFine=ID&name=NAME&data=BLOB -> SUCCESS/FAIL (Creates Fine)
    // ?auth=ID&deleteFine=ID -> SUCCESS/FAIL (Deletes Fine)

    //          FINE COMPS
    // ?auth=ID&createComp=[ID]&comp=ID&name=NAME -> SUCCESS/FAIL (creates comp)
    // ?auth=ID&comp=ID -> [ID] and Name / NULL (Lists Fines in comp)
    // ?auth=ID&deleteComp=ID -> SUCCESS/FAIL (deletes comp)


    console.log(window.location.href);

    let request = window.location.href.split("?")[1];

    console.log(request);

    if (request === null || request === "") {
        document.getElementById("Battery").innerHTML = "Bad Request";


    } else {
        let response = "Bad Request";
        let split = request.split("&");

        if (split.length === 2) {

            sp1 = split[0].split("=");
            sp2 = split[1].split("=");


            if (sp1[0] === "deleteUser" && sp2[0] === "password") {
                response = "Delete User Request";
                deleteUser(sp1[1], sp2[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "password") {
                response = "Authenticate User Request";
                authenticate(sp1[1], sp2[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "getUserProperty") {
                response = "User Property Request";
                getUserProperty(sp1[1], sp2[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "fine") {
                response = "Fine Request";
                getFine(sp2[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "fineInfo") {
                response = "Fine Info Request";
                getFineInfo(sp1[1], sp2[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "fineList") {
                response = "Fine List Request";
                getUserProperty(sp1[1], sp2[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "comp") {
                response = "Comp Request";
                getComp(sp2[1]);
            }
        }

        if (split.length === 3) {
            sp1 = split[0].split("=");
            sp2 = split[1].split("=");
            sp3 = split[2].split("=");

            if (sp1[0] === "createUser" && sp2[0] === "password" && sp3[0] === "email") {
                response = "Create User Request";
                createUser(sp1[1], sp2[1], sp3[1]);
            }
            if (sp1[0] === "auth" && sp2[0] === "password" && sp3[0] === "deleteFine") {
                response = "Fine Delete Request";
                deleteFine(sp1[1], sp2[1], sp3[1])
            }

            if (sp1[0] === "auth" && sp2[0] === "createFine" && sp3[0] === "name") {
                response = "Create Fine Request";
                createFine(sp1[1], sp2[1], sp3[1])
            }
        }

        if (split.length === 4) {
            sp1 = split[0].split("=");
            sp2 = split[1].split("=");
            sp3 = split[2].split("=");
            sp4 = split[3].split("=");



            if (sp1[0] === "auth" && sp2[0] === "createComp" && sp3[0] === "comp" && sp4[0] === "name") {
                response = "Create Comp Request";
                createComp(sp1[1], sp3[1], sp4[1], sp2[1])
            }
            if (sp1[0] === "auth" && sp1[0] === "password" && sp3[0] === "userProperty" && sp4[0] === "value") {
                response = "Set Fine Property Request";
                setUserProperty(sp1[1], sp2[1],sp3[1], sp4[1]);
            }

        }

        if (split.length === 5) {
            sp1 = split[0].split("=");
            sp2 = split[1].split("=");
            sp3 = split[2].split("=");
            sp4 = split[3].split("=");
            sp5 = split[4].split("=");

            if (sp1[0] === "auth" && sp1[0] === "password" && sp3[0] === "fine" && sp4[0] === "fineProperty" && sp5[0] === "value") {
                response = "Set Fine Property Request";
                setFineProperty(sp1[1], sp2[1],sp3[1], sp4[1], sp5[1]);
            }

        }


        document.getElementById("Battery").innerHTML = response;




    }

    function sendFine() {

        console.log("SENDING");

        let file = document.querySelector('input[type=file]').files[0];

        console.log(file);

        let fileReader = new FileReader();
        fileReader.onload = function(e) {

            console.log("LOADED");
            let content = e.target.result;
            //console.log(content);
            //remove the header and leave only the Base64 content itself

            api.setBranch('master')
                .then(() => api.pushFiles(
                    'Adding Fine: ' + '(' + file.name + ')',
                    [
                        {content: content, path: file.name},
                    ])
                )
                .then(function () {
                    document.getElementById("Battery").innerHTML = "Uploaded!";

                    try {
                        webkit.messageHandlers.SendFine.postMessage("Uploaded!");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }

                });


        };

        if (file) {
            console.log("Reading");
            fileReader.readAsDataURL(file);

        } else {
            document.getElementById("Battery").innerHTML = "Didn't work";
            try {
                webkit.messageHandlers.SendFineError.postMessage("Uploaded!");
            } catch(err) {
                console.log('The native context does not exist yet');
            }
        }



    }

    function getComp(id) {

        getUserProperty(id, "Fines").then((property) => {

            let split = property.split("*");

            let array = [];

            for (a in split) {
                let xml = new XMLHttpRequest();

                xml.open('GET',`https://raw.githubusercontent.com/${api.getRepo().__fullname}/master/${a + ".json"}`);

                xml.send();

                xml.onload = function(e) {

                    array[a] = xml.response;
                };
            }

            document.getElementById("Battery").innerHTML = JSON.stringify(array);

            try {
                webkit.messageHandlers.GetComp.postMessage(JSON.stringify(array));
            } catch(err) {
                console.log('The native context does not exist yet');
            }

        }).catch(() => {
            try {
                webkit.messageHandlers.GetCompError.postMessage("Invalid Fine");
            } catch(err) {
                console.log('The native context does not exist yet');
            }
        });




    }


    function getFine(id) {
        let xml = new XMLHttpRequest();

        xml.open('GET',`https://raw.githubusercontent.com/${api.getRepo().__fullname}/master/${id + ".mp4"}`);

        xml.send();

        xml.onload = function(e) {

            document.getElementById("Battery").innerHTML = xml.response;

            try {
                webkit.messageHandlers.GetFine.postMessage(xml.response);
            } catch(err) {
                console.log('The native context does not exist yet');
            }

        };

        xml.onerror = function(e) {
            try {
                webkit.messageHandlers.GetFineError.postMessage("Invalid Fine");
            } catch(err) {
                console.log('The native context does not exist yet');
            }
        }
    }

    function createFine(user, id, name) {

        api.getFile("Default_Fines.json").then((file) => {

            let json = JSON.parse(file);

            json["ID"] = id;
            json["Name"] = name;
            json["Author"] = user;
            json["Created"] = new Date().toJSON();

            api.setBranch('master')
                .then(() => api.pushFiles(
                    'Adding Fine: ' + id + ' (' + name + ')',
                    [
                        {content: JSON.stringify(json), path: id + '.json'},
                    ])
                )
                .then(function () {
                    document.getElementById("Battery").innerHTML = "Created File. Uploading Data...";
                    console.log('Created File. Uploading Data...');

                });

        });


    }

    function deleteFine(user, pass, id) {
        api.getFile(user + ".json").then((file) =>{

            if (file !== null) {

                let json = JSON.parse(file);

                if (json["Password"] === pass) {

                    //Possibly have to remove other things too
                    api.removeFile('master', id + ".json").then((response) => {

                        document.getElementById("Battery").innerHTML = "Deleted Fine";

                        try {
                            webkit.messageHandlers.DeleteFine.postMessage("Deleted Fine");
                        } catch(err) {
                            console.log('The native context does not exist yet');
                        }
                    });


                } else {
                    document.getElementById("Battery").innerHTML = "Incorrect Password";

                    try {
                        webkit.messageHandlers.DeleteFineError.postMessage("Incorrect Password");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }
                }


            } else {
                document.getElementById("Battery").innerHTML = "User Not Found";
                try {
                    webkit.messageHandlers.DeleteFineError.postMessage("User Not Found");
                } catch(err) {
                    console.log('The native context does not exist yet');
                }
            }

        }).catch(() => {

            try {
                webkit.messageHandlers.DeleteFineError.postMessage("Fine Not Found");
            } catch(err) {
                console.log('The native context does not exist yet');
            }

        });
    }

    function createComp(user, id, name, fines) {

        api.getFile("Default_Fines.json").then((file) => {

            let json = JSON.parse(file);

            json["ID"] = id;
            json["Name"] = name;
            json["Author"] = user;
            json["Created"] = new Date().toJSON();
            json["Fines"] = fines;

            api.setBranch('master')
                .then(() => api.pushFiles(
                    'Adding Comp: ' + id + ' (' + name + ')',
                    [
                        {content: JSON.stringify(json), path: id + '.json'},
                    ])
                )
                .then(function () {
                    document.getElementById("Battery").innerHTML = "Created Comp.";
                    console.log('Created Comp.');
                    try {
                        webkit.messageHandlers.CreateComp.postMessage("Created Comp.");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }
                });

        });


    }

    function deleteUser(id, pass) {
        api.getFile(id + ".json").then((file) =>{

            if (file !== null) {

                let json = JSON.parse(file);

                if (json["Password"] === pass) {

                    //Possibly have to remove other things too
                    api.removeFile('master', id + ".json").then((response) => {

                        document.getElementById("Battery").innerHTML = "Deleted User";

                        try {
                            webkit.messageHandlers.DeleteUser.postMessage("Deleted User");
                        } catch(err) {
                            console.log('The native context does not exist yet');
                        }

                    });


                } else {
                    document.getElementById("Battery").innerHTML = "Incorrect Password";

                    try {
                        webkit.messageHandlers.DeleteUserError.postMessage("Incorrect Password");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }
                }


            } else {
                document.getElementById("Battery").innerHTML = "User Not Found";

                try {
                    webkit.messageHandlers.DeleteUserError.postMessage("User Not Found");
                } catch(err) {
                    console.log('The native context does not exist yet');
                }
            }

        });
    }

    function authenticate(id, pass) {
        api.getFile(id + ".json").then((file) =>{

           if (file !== null) {

               let json = JSON.parse(file);

               if (json["Password"] === pass) {
                   document.getElementById("Battery").innerHTML = JSON.stringify(json)

                   try {
                       webkit.messageHandlers.Auth.postMessage(JSON.stringify(json));
                   } catch(err) {
                       console.log('The native context does not exist yet');
                   }
               } else {
                   document.getElementById("Battery").innerHTML = "Incorrect Password";

                   try {
                       webkit.messageHandlers.AuthError.postMessage("Incorrect Password");
                   } catch(err) {
                       console.log('The native context does not exist yet');
                   }
               }


           } else {
               document.getElementById("Battery").innerHTML = "User Not Found";

               try {
                   webkit.messageHandlers.AuthError.postMessage("User Not Found");
               } catch(err) {
                   console.log('The native context does not exist yet');
               }
           }

        });
    }

    function getUserProperty(id, prop) {
        api.getFile(id + ".json").then((file) =>{

            if (file !== null) {
                let json = JSON.parse(file);

                if (json[prop] !== null) {

                    document.getElementById("Battery").innerHTML = json[prop];

                    try {
                        webkit.messageHandlers.UserProperty.postMessage(json[prop]);
                    } catch (err) {
                        console.log('The native context does not exist yet');
                    }
                } else {
                    document.getElementById("Battery").innerHTML = "Invalid Property";

                    try {
                        webkit.messageHandlers.UserPropertyError.postMessage("Invalid Property");
                    } catch (err) {
                        console.log('The native context does not exist yet');
                    }
                }
            } else {
                document.getElementById("Battery").innerHTML = "User Not Found";

                try {
                    webkit.messageHandlers.UserPropertyError.postMessage("User Not Found");
                } catch(err) {
                    console.log('The native context does not exist yet');
                }
            }

        });
    }

    function getFineInfo(fine) {
        api.getFile(fine + ".json").then((file) =>{

            if (file !== null) {

                let json = JSON.parse(file);
                document.getElementById("Battery").innerHTML = JSON.stringify(json);

                try {
                    webkit.messageHandlers.FineInfo.postMessage(JSON.stringify(json));
                } catch(err) {
                    console.log('The native context does not exist yet');
                }

            } else {
                document.getElementById("Battery").innerHTML = "Fine Not Found";

                try {
                    webkit.messageHandlers.FineInfoError.postMessage("Fine Not Found");
                } catch(err) {
                    console.log('The native context does not exist yet');
                }
            }

        }).catch(() => {
            try {
                webkit.messageHandlers.FineInfoError.postMessage("Fine Not Found");
            } catch(err) {
                console.log('The native context does not exist yet');
            }
        });
    }

    function setFineProperty(id, pass, fine, prop, value) {
        api.getFile(id + ".json").then((file) =>{

            if (file !== null) {

                let json = JSON.parse(file);

                if (json["Password"] === pass) {

                    api.getFile(fine + ".json").then((fine) => {
                        let j = JSON.parse(fine);

                        if (j[prop] !== null) {

                            j[prop] = value;

                            api.setBranch('master')
                                .then(() => api.pushFiles(
                                    'Changing A property for Fine: ' + fine,
                                    [
                                        {content: JSON.stringify(j), path: fine + '.json'},
                                    ])
                                )
                                .then(function () {
                                    document.getElementById("Battery").innerHTML = "Changed Property";
                                    console.log('Changed Property!');
                                    try {
                                        webkit.messageHandlers.SetFineProperty.postMessage("Changed Property");
                                    } catch(err) {
                                        console.log('The native context does not exist yet');
                                    }
                                });

                        } else {
                            document.getElementById("Battery").innerHTML = "Invalid Property";

                            try {
                                webkit.messageHandlers.SetFinePropertyError.postMessage("Invalid Property");
                            } catch(err) {
                                console.log('The native context does not exist yet');
                            }
                        }

                    });


                } else {
                    document.getElementById("Battery").innerHTML = "Incorrect Password";
                    try {
                        webkit.messageHandlers.SetFinePropertyError.postMessage("Incorrect Password");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }
                }





            } else {
                document.getElementById("Battery").innerHTML = "User Not Found";

                try {
                    webkit.messageHandlers.SetFinePropertyError.postMessage("User Not Found");
                } catch(err) {
                    console.log('The native context does not exist yet');
                }
            }

        }).catch(() => {
            try {
                webkit.messageHandlers.SetFinePropertyError.postMessage("Fine Not Found");
            } catch(err) {
                console.log('The native context does not exist yet');
            }
        });
    }

    function setUserProperty(id, pass, prop, value) {
        api.getFile(id + ".json").then((file) =>{

            if (file !== null) {

                let json = JSON.parse(file);

                if (json["Password"] === pass) {

                    if (json[prop] !== null) {

                        json[prop] = value;

                        api.setBranch('master')
                            .then(() => api.pushFiles(
                                'Changing A property for user: ' + id,
                                [
                                    {content: JSON.stringify(json), path: id + '.json'},
                                ])
                            )
                            .then(function () {
                                document.getElementById("Battery").innerHTML = "Changed Property";
                                console.log('Changed Property!');

                                try {
                                    webkit.messageHandlers.SetUserProperty.postMessage("Changed Property");
                                } catch(err) {
                                    console.log('The native context does not exist yet');
                                }
                            });

                    } else {
                        document.getElementById("Battery").innerHTML = "Invalid Property";

                        try {
                            webkit.messageHandlers.SetUserPropertyError.postMessage("Invalid Property");
                        } catch(err) {
                            console.log('The native context does not exist yet');
                        }

                    }
                } else {
                    document.getElementById("Battery").innerHTML = "Incorrect Password";

                    try {
                        webkit.messageHandlers.SetUserPropertyError.postMessage("Incorrect Password");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }
                }





            } else {
                document.getElementById("Battery").innerHTML = "User Not Found";

                try {
                    webkit.messageHandlers.SetUserPropertyError.postMessage("User Not Found");
                } catch(err) {
                    console.log('The native context does not exist yet');
                }
            }

        });
    }

    function createUser(id, pass, email) {

        api.getFile("Default_User.json").then((file) => {

            let json = JSON.parse(file);

            json["ID"] = id;
            json["Password"] = pass;
            json["Creation"] = new Date().toJSON();
            json["LastLogin"] = new Date().toJSON();
            json["Email"] = email;

            api.setBranch('master')
                .then(() => api.pushFiles(
                    'Adding User: ' + id,
                    [
                        {content: JSON.stringify(json), path: id + '.json'},
                    ])
                )
                .then(function () {
                    document.getElementById("Battery").innerHTML = "User Created!";
                    console.log('User Created!');

                    try {
                        webkit.messageHandlers.CreateUser.postMessage("User Created");
                    } catch(err) {
                        console.log('The native context does not exist yet');
                    }

                });

        });



    }

</script>

</body>


</html>